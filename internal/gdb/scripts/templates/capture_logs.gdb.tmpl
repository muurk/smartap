# GDB Script: Capture Device UART Logs
# This script sets a breakpoint on the UART logging function and captures log messages
# Generated by smartap-cfg gdb capture-logs

set pagination off
set confirm off
set height 0
set width 0

# Connect to OpenOCD
target extended-remote {{.OpenOCDHost}}:{{.OpenOCDPort}}

# Halt the device
monitor halt

echo [1/3] Setting up log capture...\n

# Set breakpoint on UART log function
# Function signature: void uart_log(const char *format, ...)
# r0 contains pointer to format string
# r1-r3 contain first 3 arguments
break *{{printf "0x%x" .Firmware.Functions.UartLog}}

# Configure breakpoint to continue after hitting
commands
  silent
  set $log_msg = (char*)$r0
  printf "[LOG] %s", $log_msg
  continue
end

echo [2/3] Log capture configured...\n

# Resume device
echo [3/3] Resuming device...\n
continue

# This will run until user interrupts (Ctrl+C) or duration expires
