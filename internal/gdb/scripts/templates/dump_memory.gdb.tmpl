# GDB Script: Dump Device Memory
# This script dumps a region of device memory to a binary file using OpenOCD's dump_image
# Generated by smartap-cfg gdb dump-memory

set pagination off
set confirm off

# Increase GDB remote timeout to handle large memory dumps
# Default is 2 seconds, we set to 60 seconds for safety
set remotetimeout 60

# Connect to OpenOCD
target extended-remote {{.OpenOCDHost}}:{{.OpenOCDPort}}

# Halt the device
echo [1/3] Halting device...\n
monitor halt

# Disable watchdog to prevent reset during memory dump
monitor mww 0x40000000 0x00000000

# Dump memory using GDB's dump command (writes locally, not on OpenOCD server)
# Syntax: dump binary memory <filename> <start_addr> <end_addr>
# Note: GDB dump uses end address, not size
echo [2/3] Dumping memory from {{printf "0x%x" .StartAddress}} ({{.Size}} bytes)...\n
dump binary memory {{.OutputFile}} {{printf "0x%x" .StartAddress}} {{printf "0x%x" .EndAddress}}

echo [3/3] Memory dump complete...\n

# Resume device
monitor resume

# Print success marker
echo [SUCCESS]\n

# Disconnect cleanly
disconnect
quit
