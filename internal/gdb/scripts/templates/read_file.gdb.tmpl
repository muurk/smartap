# GDB Script: Read File from Device Filesystem
# This script reads a file from the CC3200 SimpleLink filesystem
# Generated by smartap-cfg gdb read-file

set pagination off
set confirm off

# Increase GDB remote timeout for potentially large file reads
set remotetimeout 60

# Connect to OpenOCD
target extended-remote {{.OpenOCDHost}}:{{.OpenOCDPort}}

# Halt the device
monitor halt

# Disable watchdog to prevent reset during file operations
monitor mww 0x40000000 0x00000000

echo [1/6] Halting device...\n

# Setup memory locations
set $work_buffer = {{printf "0x%x" .Firmware.Memory.WorkBuffer}}
set $file_handle_ptr = {{printf "0x%x" .Firmware.Memory.FileHandlePtr}}
set $filename_ptr = {{printf "0x%x" .Firmware.Memory.FilenamePtr}}
set $token_ptr = {{printf "0x%x" .Firmware.Memory.TokenPtr}}
set $stack_base = {{printf "0x%x" .Firmware.Memory.StackBase}}

# Setup filename in memory
echo [2/6] Setting up filename...\n
{{range $i, $char := .FilenameBytes}}set *((unsigned char*)($filename_ptr + {{$i}})) = {{$char}}
{{end}}set *((unsigned char*)($filename_ptr + {{len .FilenameBytes}})) = 0

# Open file for reading
# sl_FsOpen(filename, FS_MODE_OPEN_READ, token, &file_handle)
echo [3/6] Opening file for reading...\n
set $r0 = $filename_ptr
set $r1 = 0
set $r2 = $token_ptr
set $r3 = $file_handle_ptr
set $pc = {{printf "0x%x" .Firmware.Functions.SlFsOpen}}
set $lr = 0x20000001
set $sp = $stack_base
finish

set $open_result = $r0
set $file_handle = *(int*)$file_handle_ptr
printf "open_result: %d\n", $open_result
printf "file_handle: 0x%x\n", $file_handle

# Check if file was opened successfully
if $open_result < 0
  echo Error: Failed to open file\n
  printf "sl_FsOpen returned: %d\n", $open_result
  monitor resume
  disconnect
  quit
end

# Read file data
# sl_FsRead(file_handle, offset, buffer, length)
echo [4/6] Reading file data...\n
set $r0 = $file_handle
set $r1 = 0
set $r2 = $work_buffer
set $r3 = {{.MaxSize}}
set $pc = {{printf "0x%x" .Firmware.Functions.SlFsRead}}
set $lr = 0x20000001
finish

set $bytes_read = $r0
printf "bytes_read: %d\n", $bytes_read

# Check if read was successful
if $bytes_read < 0
  echo Error: Failed to read file\n
  printf "sl_FsRead returned: %d\n", $bytes_read
  # Close file before exiting
  set $r0 = $file_handle
  set $r1 = 0
  set $r2 = 0
  set $r3 = 0
  set $pc = {{printf "0x%x" .Firmware.Functions.SlFsClose}}
  set $lr = 0x20000001
  finish
  monitor resume
  disconnect
  quit
end

# Save data to file using GDB dump
echo [5/6] Saving file data...\n
dump binary memory {{.OutputFile}} $work_buffer ($work_buffer + $bytes_read)

# Close file
# sl_FsClose(file_handle, NULL, NULL, 0)
echo [6/6] Closing file...\n
set $r0 = $file_handle
set $r1 = 0
set $r2 = 0
set $r3 = 0
set $pc = {{printf "0x%x" .Firmware.Functions.SlFsClose}}
set $lr = 0x20000001
finish

set $close_result = $r0
printf "close_result: %d\n", $close_result

# Resume device
monitor resume

# Print success marker
echo [SUCCESS]\n

# Disconnect cleanly
disconnect
quit
