# GDB Script: Firmware Version Detection via Signature Matching
#
# This script detects the firmware version by reading memory at known function
# addresses and comparing against expected signatures. If all signatures match
# for a known firmware version, we report that version with high confidence.
#
# Generated by smartap-cfg gdb detect-firmware

set pagination off
set confirm off

# Connect to OpenOCD
target extended-remote {{.OpenOCDHost}}:{{.OpenOCDPort}}

# Halt the device
monitor halt

# Disable watchdog to prevent reset during inspection
monitor mww 0x40000000 0x00000000

printf "\n"
printf "╔══════════════════════════════════════════════════════════════════╗\n"
printf "║           SMARTAP FIRMWARE VERSION DETECTION                     ║\n"
printf "║              (Signature-Based Matching)                          ║\n"
printf "╚══════════════════════════════════════════════════════════════════╝\n"
printf "\n"

# ============================================================================
# SIGNATURE MATCHING
# ============================================================================
# Each firmware version has known function addresses and their expected
# signatures (first 8 bytes as two 32-bit words). We check each firmware
# version and calculate confidence based on signature matches.

# Result variables
set $detected_version = 0
set $detected_name = "UNKNOWN"
set $best_confidence = 0
set $best_matches = 0

printf "Checking known firmware versions...\n\n"

{{range $fwIdx, $fw := .Firmwares}}
# ----------------------------------------------------------------------------
# CHECK VERSION {{$fw.Version}}
# ----------------------------------------------------------------------------
printf "══════════════════════════════════════════════════════════════════\n"
printf "Checking: {{$fw.Version}} ({{$fw.Name}})\n"
printf "══════════════════════════════════════════════════════════════════\n\n"

set $v{{$fwIdx}}_matches = 0
set $v{{$fwIdx}}_total = {{len $fw.Functions.Signatures}}

{{if $fw.Functions.Signatures}}
{{if $fw.Functions.Signatures.sl_FsOpen}}
# Check sl_FsOpen
set $actual0 = *(unsigned int*){{printf "0x%x" $fw.Functions.SlFsOpen}}
set $actual1 = *(unsigned int*)({{printf "0x%x" $fw.Functions.SlFsOpen}} + 4)
printf "  sl_FsOpen    @ {{printf "0x%08x" $fw.Functions.SlFsOpen}}: "
{{with index $fw.Functions.Signatures "sl_FsOpen"}}
if $actual0 == {{index . 0}} && $actual1 == {{index . 1}}
  printf "MATCH\n"
  set $v{{$fwIdx}}_matches = $v{{$fwIdx}}_matches + 1
else
  printf "MISMATCH (got 0x%08x 0x%08x, expected 0x%08x 0x%08x)\n", $actual0, $actual1, {{index . 0}}, {{index . 1}}
end
{{end}}
{{end}}

{{if $fw.Functions.Signatures.sl_FsRead}}
# Check sl_FsRead
set $actual0 = *(unsigned int*){{printf "0x%x" $fw.Functions.SlFsRead}}
set $actual1 = *(unsigned int*)({{printf "0x%x" $fw.Functions.SlFsRead}} + 4)
printf "  sl_FsRead    @ {{printf "0x%08x" $fw.Functions.SlFsRead}}: "
{{with index $fw.Functions.Signatures "sl_FsRead"}}
if $actual0 == {{index . 0}} && $actual1 == {{index . 1}}
  printf "MATCH\n"
  set $v{{$fwIdx}}_matches = $v{{$fwIdx}}_matches + 1
else
  printf "MISMATCH (got 0x%08x 0x%08x, expected 0x%08x 0x%08x)\n", $actual0, $actual1, {{index . 0}}, {{index . 1}}
end
{{end}}
{{end}}

{{if $fw.Functions.Signatures.sl_FsWrite}}
# Check sl_FsWrite
set $actual0 = *(unsigned int*){{printf "0x%x" $fw.Functions.SlFsWrite}}
set $actual1 = *(unsigned int*)({{printf "0x%x" $fw.Functions.SlFsWrite}} + 4)
printf "  sl_FsWrite   @ {{printf "0x%08x" $fw.Functions.SlFsWrite}}: "
{{with index $fw.Functions.Signatures "sl_FsWrite"}}
if $actual0 == {{index . 0}} && $actual1 == {{index . 1}}
  printf "MATCH\n"
  set $v{{$fwIdx}}_matches = $v{{$fwIdx}}_matches + 1
else
  printf "MISMATCH (got 0x%08x 0x%08x, expected 0x%08x 0x%08x)\n", $actual0, $actual1, {{index . 0}}, {{index . 1}}
end
{{end}}
{{end}}

{{if $fw.Functions.Signatures.sl_FsClose}}
# Check sl_FsClose
set $actual0 = *(unsigned int*){{printf "0x%x" $fw.Functions.SlFsClose}}
set $actual1 = *(unsigned int*)({{printf "0x%x" $fw.Functions.SlFsClose}} + 4)
printf "  sl_FsClose   @ {{printf "0x%08x" $fw.Functions.SlFsClose}}: "
{{with index $fw.Functions.Signatures "sl_FsClose"}}
if $actual0 == {{index . 0}} && $actual1 == {{index . 1}}
  printf "MATCH\n"
  set $v{{$fwIdx}}_matches = $v{{$fwIdx}}_matches + 1
else
  printf "MISMATCH (got 0x%08x 0x%08x, expected 0x%08x 0x%08x)\n", $actual0, $actual1, {{index . 0}}, {{index . 1}}
end
{{end}}
{{end}}

{{if $fw.Functions.Signatures.sl_FsDel}}
# Check sl_FsDel
set $actual0 = *(unsigned int*){{printf "0x%x" $fw.Functions.SlFsDel}}
set $actual1 = *(unsigned int*)({{printf "0x%x" $fw.Functions.SlFsDel}} + 4)
printf "  sl_FsDel     @ {{printf "0x%08x" $fw.Functions.SlFsDel}}: "
{{with index $fw.Functions.Signatures "sl_FsDel"}}
if $actual0 == {{index . 0}} && $actual1 == {{index . 1}}
  printf "MATCH\n"
  set $v{{$fwIdx}}_matches = $v{{$fwIdx}}_matches + 1
else
  printf "MISMATCH (got 0x%08x 0x%08x, expected 0x%08x 0x%08x)\n", $actual0, $actual1, {{index . 0}}, {{index . 1}}
end
{{end}}
{{end}}

{{if $fw.Functions.Signatures.sl_FsGetInfo}}
# Check sl_FsGetInfo
set $actual0 = *(unsigned int*){{printf "0x%x" $fw.Functions.SlFsGetInfo}}
set $actual1 = *(unsigned int*)({{printf "0x%x" $fw.Functions.SlFsGetInfo}} + 4)
printf "  sl_FsGetInfo @ {{printf "0x%08x" $fw.Functions.SlFsGetInfo}}: "
{{with index $fw.Functions.Signatures "sl_FsGetInfo"}}
if $actual0 == {{index . 0}} && $actual1 == {{index . 1}}
  printf "MATCH\n"
  set $v{{$fwIdx}}_matches = $v{{$fwIdx}}_matches + 1
else
  printf "MISMATCH (got 0x%08x 0x%08x, expected 0x%08x 0x%08x)\n", $actual0, $actual1, {{index . 0}}, {{index . 1}}
end
{{end}}
{{end}}

{{if $fw.Functions.Signatures.uart_log}}
# Check uart_log
set $actual0 = *(unsigned int*){{printf "0x%x" $fw.Functions.UartLog}}
set $actual1 = *(unsigned int*)({{printf "0x%x" $fw.Functions.UartLog}} + 4)
printf "  uart_log     @ {{printf "0x%08x" $fw.Functions.UartLog}}: "
{{with index $fw.Functions.Signatures "uart_log"}}
if $actual0 == {{index . 0}} && $actual1 == {{index . 1}}
  printf "MATCH\n"
  set $v{{$fwIdx}}_matches = $v{{$fwIdx}}_matches + 1
else
  printf "MISMATCH (got 0x%08x 0x%08x, expected 0x%08x 0x%08x)\n", $actual0, $actual1, {{index . 0}}, {{index . 1}}
end
{{end}}
{{end}}
{{else}}
printf "  No signatures available for this firmware version\n"
{{end}}

# Calculate confidence for {{$fw.Version}}
set $v{{$fwIdx}}_confidence = ($v{{$fwIdx}}_matches * 100) / $v{{$fwIdx}}_total
printf "\n  Result: %d/%d signatures matched (%d%% confidence)\n", $v{{$fwIdx}}_matches, $v{{$fwIdx}}_total, $v{{$fwIdx}}_confidence

# Update best match if this is better
if $v{{$fwIdx}}_confidence > $best_confidence
  set $best_confidence = $v{{$fwIdx}}_confidence
  set $best_matches = $v{{$fwIdx}}_matches
  set $detected_version = {{$fw.Version}}
end

# Early exit on 100% match
if $best_confidence == 100
  printf "\n*** PERFECT MATCH FOUND - Stopping checks ***\n"
  loop_break
end

printf "\n"

{{end}}

# ============================================================================
# FINAL RESULT
# ============================================================================

printf "══════════════════════════════════════════════════════════════════\n"
printf "DETECTION RESULT\n"
printf "══════════════════════════════════════════════════════════════════\n\n"

if $best_confidence == 100
  printf "*** FIRMWARE DETECTED: %s ***\n", $detected_version
  printf "    Confidence: %d%% (all signatures matched)\n", $best_confidence
  printf "    Status: HIGH CONFIDENCE - Safe to use this version's addresses\n"
else
  if $best_confidence >= 85
    printf "*** FIRMWARE LIKELY: %s ***\n", $detected_version
    printf "    Confidence: %d%% (%d signatures matched)\n", $best_confidence, $best_matches
    printf "    Status: MEDIUM CONFIDENCE - Some signatures did not match\n"
  else
    if $best_confidence > 0
      printf "*** FIRMWARE UNLIKELY: %s ***\n", $detected_version
      printf "    Confidence: %d%% (%d signatures matched)\n", $best_confidence, $best_matches
      printf "    Status: LOW CONFIDENCE - Probably wrong version\n"
    else
      printf "*** FIRMWARE UNKNOWN ***\n"
      printf "    No known firmware signatures matched.\n"
    end
  end
end

printf "\n"

# ============================================================================
# MACHINE-READABLE OUTPUT
# ============================================================================
# This section provides output that can be easily parsed by the application.
# Format: KEY=VALUE (one per line)

printf "══════════════════════════════════════════════════════════════════\n"
printf "MACHINE-READABLE OUTPUT (for parsing)\n"
printf "══════════════════════════════════════════════════════════════════\n\n"

printf "DETECTED_VERSION=0x%x\n", $detected_version
printf "CONFIDENCE=%d\n", $best_confidence
printf "MATCHES=%d\n", $best_matches

# Output function addresses if we have a high confidence match
if $best_confidence >= 85
  printf "STATUS=OK\n"
{{range $fwIdx, $fw := .Firmwares}}
  if $detected_version == {{$fw.Version}}
    printf "sl_FsOpen={{printf "0x%08x" $fw.Functions.SlFsOpen}}\n"
    printf "sl_FsRead={{printf "0x%08x" $fw.Functions.SlFsRead}}\n"
    printf "sl_FsWrite={{printf "0x%08x" $fw.Functions.SlFsWrite}}\n"
    printf "sl_FsClose={{printf "0x%08x" $fw.Functions.SlFsClose}}\n"
    printf "sl_FsDel={{printf "0x%08x" $fw.Functions.SlFsDel}}\n"
    printf "sl_FsGetInfo={{printf "0x%08x" $fw.Functions.SlFsGetInfo}}\n"
    printf "uart_log={{printf "0x%08x" $fw.Functions.UartLog}}\n"
    printf "work_buffer={{printf "0x%08x" $fw.Memory.WorkBuffer}}\n"
  end
{{end}}
else
  printf "STATUS=UNKNOWN\n"
end

printf "\n"
printf "══════════════════════════════════════════════════════════════════\n"
printf "DETECTION COMPLETE\n"
printf "══════════════════════════════════════════════════════════════════\n"
printf "\n"

# Resume the device
monitor resume

# Disconnect cleanly
disconnect
quit
