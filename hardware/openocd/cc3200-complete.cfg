# =============================================================================
# CC3200 OpenOCD Configuration
# =============================================================================
#
# Complete OpenOCD configuration for Texas Instruments CC3200 (used in Smartap
# devices). Combines target setup with watchdog handling for reliable debugging.
#
# Usage:
#   openocd -f ./sysfsgpio-smartap.cfg -c "transport select jtag" -c "bindto 0.0.0.0" \
#           -f ./cc3200-complete.cfg
#
# Features:
#   - Automatic watchdog extension on halt (prevents device reset during debug)
#
# Part of the Smartap Project
# https://github.com/muurk/smartap
#
# =============================================================================

# Combined CC3200 configuration with flash support

  source [find target/swj-dp.tcl]
  source [find target/icepick.cfg]

  if { [info exists CHIPNAME] } {
      set _CHIPNAME $CHIPNAME
  } else {
      set _CHIPNAME cc32xx
  }

  if { [info exists DAP_TAPID] } {
      set _DAP_TAPID $DAP_TAPID
  } else {
      if {[using_jtag]} {
          set _DAP_TAPID 0x4BA00477
      } else {
          set _DAP_TAPID 0x2BA01477
      }
  }

  if {[using_jtag]} {
      jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_DAP_TAPID -disable
      jtag configure $_CHIPNAME.cpu -event tap-enable "icepick_c_tapenable $_CHIPNAME.jrc 0"
  } else {
      swj_newdap $_CHIPNAME cpu -expected-id $_DAP_TAPID
  }

  if { [info exists JRC_TAPID] } {
      set _JRC_TAPID $JRC_TAPID
  } else {
      set _JRC_TAPID 0x0B97C02F
  }

  if {[using_jtag]} {
      jtag newtap $_CHIPNAME jrc -irlen 6 -ircapture 0x1 -irmask 0x3f -expected-id $_JRC_TAPID -ignore-version
      jtag configure $_CHIPNAME.jrc -event setup "jtag tapenable $_CHIPNAME.cpu"
  }

  set _TARGETNAME $_CHIPNAME.cpu
  dap create $_CHIPNAME.dap -chain-position $_CHIPNAME.cpu
  target create $_TARGETNAME cortex_m -dap $_CHIPNAME.dap

  if { [info exists WORKAREASIZE] } {
      set _WORKAREASIZE $WORKAREASIZE
  } else {
      set _WORKAREASIZE 0x2000
  }

  $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size $_WORKAREASIZE -work-area-backup 0

  # Watchdog handling
  $_TARGETNAME configure -event halted {
      echo "Extending watchdog timer..."
      mww 0x40000C00 0x1ACCE551
      mww 0x40000000 0xFFFFFFFF
      mww 0x40000C00 0x00000000
      echo "Watchdog timer extended to maximum"
  }

  $_TARGETNAME configure -event reset-end {
      echo "Extending watchdog after reset..."
      mww 0x40000C00 0x1ACCE551
      mww 0x40000000 0xFFFFFFFF
      mww 0x40000C00 0x00000000
  }
